{% extends "base.html" %}

{% block title %}Ressourcerie - Découvrir les produits{% endblock %}

{% block content %}
<header class="top-hero top-hero--public">
    <div class="top-hero__overlay"></div>
    <div class="top-hero__content">
        <h1 class="screen-title">La ressourcerie</h1>
        <p class="screen-subtitle">Découvrez les objets disponibles, comme sur Leboncoin mais local.</p>
        <form method="get" class="search-bar">
            {% if category %}
                <input type="hidden" name="category" value="{{ category }}">
            {% endif %}
            <input
                type="search"
                name="q"
                value="{{ query }}"
                class="search-bar__input"
                placeholder="Rechercher un objet, une matière, une catégorie...">
            <button type="submit" class="search-bar__button">Rechercher</button>
        </form>
        <div class="filters">
            <a class="filters__chip filters__chip--ghost {% if not category %}filters__chip--active{% endif %}"
               href="{% if query %}?q={{ query|urlencode }}{% else %}/{% endif %}">Tout</a>
            {% for value, label in categories %}
                <a class="filters__chip {% if category == value %}filters__chip--active{% endif %}"
                   href="?category={{ value }}{% if query %}&q={{ query|urlencode }}{% endif %}">
                    {{ label }}
                </a>
            {% endfor %}
        </div>
    </div>
</header>

<main class="screen screen--with-hero">
    <section class="section">
        <h2 class="section-title">Les dernières trouvailles</h2>
        <div class="cards-grid">
            {% for product in products %}
                <article class="card card--product" data-product-id="{{ product.id }}"
                         data-product-title="{{ product.title|escapejs }}"
                         data-product-description="{{ product.description|linebreaksbr|escapejs }}"
                         data-product-dimensions="{{ product.dimensions|escapejs }}"
                         data-product-image="{% if product.image %}{{ product.image.url }}{% endif %}"
                         data-product-alt="{{ product.image_alt|default:product.title|escapejs }}">
                    <div class="card__image-wrapper">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.image_alt|default:product.title }}">
                        {% endif %}
                    </div>
                    <div class="card__body">
                        <h3 class="card__title">{{ product.title }}</h3>
                        <p class="card__meta">{{ product.get_category_display }}</p>
                        {% if product.dimensions %}
                            <p class="card__meta">{{ product.dimensions }}</p>
                        {% endif %}
                        <p class="card__excerpt">
                            {{ product.description|truncatechars:80 }}
                        </p>
                    </div>
                </article>
            {% empty %}
                <p class="empty-state-text">Aucun produit n'est disponible pour le moment.</p>
            {% endfor %}
        </div>
    </section>
</main>

<footer class="site-footer">
    <div class="site-footer__content">
        <div>
            <h3 class="site-footer__title">Ressourcerie</h3>
            <p class="site-footer__text">Objets revalorisés, circuits courts, impact local.</p>
        </div>
        <div class="site-footer__links">
            <a href="#hero">Accueil</a>
            <a href="mailto:contact@example.com">Contact</a>
        </div>
    </div>
    <p class="site-footer__copy">© {{ now|date:"Y" }} Ressourcerie — Reuse & Upcycling</p>
</footer>

<div class="product-modal" id="productModal" aria-hidden="true">
    <div class="product-modal__backdrop"></div>
    <div class="product-modal__content">
        <button class="product-modal__close" type="button" aria-label="Fermer">×</button>
        <div class="product-modal__image-wrapper">
            <img id="modalImage" src="" alt="">
        </div>
        <div class="product-modal__body">
            <h2 id="modalTitle"></h2>
            <p id="modalDimensions" class="card__meta"></p>
            <p id="modalDescription"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        const modal = document.getElementById('productModal');
        if (!modal) return;

        const backdrop = modal.querySelector('.product-modal__backdrop');
        const closeBtn = modal.querySelector('.product-modal__close');
        const imageEl = document.getElementById('modalImage');
        const titleEl = document.getElementById('modalTitle');
        const dimensionsEl = document.getElementById('modalDimensions');
        const descriptionEl = document.getElementById('modalDescription');

        function openModal(card) {
            const title = card.getAttribute('data-product-title');
            const description = card.getAttribute('data-product-description');
            const dimensions = card.getAttribute('data-product-dimensions');
            const image = card.getAttribute('data-product-image');
            const alt = card.getAttribute('data-product-alt');

            titleEl.textContent = title || '';
            dimensionsEl.textContent = dimensions || '';
            descriptionEl.innerHTML = description || '';

            if (image) {
                imageEl.src = image;
                imageEl.alt = alt || title || '';
                imageEl.style.display = 'block';
            } else {
                imageEl.style.display = 'none';
            }

            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('no-scroll');
        }

        function closeModal() {
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('no-scroll');
        }

        document.querySelectorAll('.card--product').forEach(function (card) {
            card.addEventListener('click', function () {
                openModal(card);
            });
        });

        backdrop.addEventListener('click', closeModal);
        closeBtn.addEventListener('click', closeModal);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    })();
</script>
{% endblock %}

